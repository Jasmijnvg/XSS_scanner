package com.jasmi.xss_scanner.services;

import com.jasmi.xss_scanner.dtos.vulnerability.VulnerabilityInputDto;
import com.jasmi.xss_scanner.dtos.vulnerability.VulnerabilityOutputDto;
import com.jasmi.xss_scanner.exceptions.RecordNotFoundException;
import com.jasmi.xss_scanner.mappers.SolutionMapper;
import com.jasmi.xss_scanner.mappers.VulnerabilityMapper;
import com.jasmi.xss_scanner.models.Vulnerability;
import com.jasmi.xss_scanner.repositories.SolutionRepository;
import com.jasmi.xss_scanner.repositories.VulnerabilityRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
public class VulnerabilityService {
    private final VulnerabilityRepository vulnerabilityRepository;
    private final VulnerabilityMapper vulnerabilityMapper;

    public VulnerabilityService(VulnerabilityRepository vulnerabilityRepository, VulnerabilityMapper vulnerabilityMapper, SolutionMapper solutionMapper, SolutionRepository solutionRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
        this.vulnerabilityMapper = vulnerabilityMapper;
    }

    public List<VulnerabilityOutputDto> getAllVulnerabilities() {
        return vulnerabilityRepository.findAll()
                .stream()
                .map((x)->vulnerabilityMapper.toVulnerabilityDto(x))
                .collect(Collectors.toList());
    }

    public VulnerabilityOutputDto getVulnerabilityById(long id) {
        Optional<Vulnerability> optionalVulnerability = vulnerabilityRepository.findById(id);
        if (optionalVulnerability.isPresent()) {
            Vulnerability v = optionalVulnerability.get();
            return vulnerabilityMapper.toVulnerabilityDto(v);
        }
        else {
            throw new RecordNotFoundException("Vulnerability " + id + " not found");
        }
    }

    public VulnerabilityOutputDto saveVulnerability(VulnerabilityInputDto vulnerabilityInputDto) {
        Vulnerability v = vulnerabilityMapper.toVulnerability(vulnerabilityInputDto);
        Vulnerability savedVulnerability = vulnerabilityRepository.save(v);
        return vulnerabilityMapper.toVulnerabilityDto(savedVulnerability);
    }

    public VulnerabilityOutputDto updateVulnerability(long id, VulnerabilityInputDto updatedVulnerability) {
       if(!vulnerabilityRepository.existsById(id)){
           throw new RecordNotFoundException("Vulnerability "+id+" not found");
       }
        Vulnerability v = vulnerabilityMapper.toVulnerability(updatedVulnerability);
        v.setId(id);
        Vulnerability vulnerability = vulnerabilityRepository.save(v);
        return vulnerabilityMapper.toVulnerabilityDto(vulnerability);

    }

    public void deleteVulnerability(long id) {
        if(vulnerabilityRepository.existsById(id)){
            vulnerabilityRepository.deleteById(id);
        }
        else{
            throw new RecordNotFoundException("Vulnerability "+id+" not found");
        }
    }
}
